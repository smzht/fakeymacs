#+STARTUP: showall indent

* Fakeymacs extension - shell_command_on_region -

** ■ Emacs の shell-command-on-region の機能をサポートする

Emacs の shell-command-on-region の機能をサポートするための拡張機能です。

*** コンフィグレーションパラメータ

|-------------------------+------------------------------------------------------------------------------------|
| Configuration parameter | Description                                                                        |
|-------------------------+------------------------------------------------------------------------------------|
| fc.output_line_count    | 実行結果を Keyhac コンソールに出力する行数を指定する                               |
| fc.foreground_timeout   | フォアグラウンド処理（C-u の前置が１回以下の場合）のタイムアウト値（秒）を指定する |
| fc.background_timeout   | バックグラウンド処理（C-u を２回前置した場合）のタイムアウト値（秒）を指定する     |
|-------------------------+------------------------------------------------------------------------------------|
| fc.unix_tool            | Unix コマンドを起動するために利用する Unix ツールを指定する                        |
| fc.bash_options         | Bash のオプション（-c 以外）を指定する                                             |
|-------------------------+------------------------------------------------------------------------------------|
| fc.MSYS2_path           | MSYS2 をインストールしているパスを指定する                                         |
| fc.Cygwin_path          | Cygwin をインストールしているパスを指定する                                        |
| fc.BusyBox_path         | BusyBox をインストールしているパスを指定する                                       |
|-------------------------+------------------------------------------------------------------------------------|

*** キーバインド

|---------+-------------------------+-------------|
| Keybind | Function                | Description |
|---------+-------------------------+-------------|
| M-\vert | shell_command_on_region |             |
|---------+-------------------------+-------------|

*** 環境設定

WSL/WSL2、MSYS2、Cygwin、BusyBox で動作します。

予め、いずれかのツールをインストールしてください。

BusyBox を利用する場合は、次のサイトを参考に busybox64.exe を shell_command_on_region の Extention
フォルダの配下にインストールしてください。既に別の場所に busybox64.exe をインストールしている場合には、
そのインストールしている場所を BusyBox_path 変数に指定してください。

- https://qiita.com/tetsuy/items/22cba0bc2048967b270a

MSYS2、Cygwin を利用する場合でデフォルトのインストールパス以外の場所にツールをインストールする場合には、
MSYS2_path もしくは Cygwin_path 変数を指定してください。

最後に、unix_tool 変数に、利用する Unix ツールの名称を指定してください。

*** 動作仕様

- M-| の押下により shell command を入力するダイヤログが開く（ここにコマンドを入力する）
- リージョンが選択されている場合には、そのリージョンがコマンドの標準入力に投入される
- リージョンが選択されていない場合には、空文字列がコマンドの標準入力に投入される
- コマンドの実行結果はクリップボードに格納されるほか、最初の10行が Keyhac コンソールに出力される
- さらに、C-u M-| のように C-u を前置すると、コマンドの実行結果でリージョンが置き換えられる
- もしくは、C-u C-u M-| のように C-u を２回前置すると、バックグランドでコマンドが実行される
- ダイヤログで入力したコマンドはクリップボードリストに登録されるので、再利用可能である

*** 使用例

|---------------------------------------+-----------------------------------------------------------------------------------------|
| Shell command                         | Description                                                                             |
|---------------------------------------+-----------------------------------------------------------------------------------------|
| M-\vert date                          | 日付をクリップボードに格納する                                                          |
| M-\vert wc -l                         | リージョンの行数を数え、結果をクリップボードに格納する                                  |
| M-\vert grep 'foo'                    | リージョンの foo を含む行を抽出し、結果をクリップボードに格納する                       |
| C-u M-\vert sort                      | リージョンをソートした内容で置き換える                                                  |
| C-u M-\vert tac                       | リージョンの行の並びを逆順にして置き換える                                              |
| C-u M-\vert sed 's/foo/bar/g'         | リージョンにある foo を bar に全て置き換える                                            |
| C-u M-\vert nl -ba                    | リージョンに行番号を付ける                                                              |
| C-u M-\vert seq 10                    | リージョンを 10 までの連番で置き換える                                                  |
| C-u M-\vert awk '{print $1 + 10}'     | リージョンを awk コマンドの結果で置き換える（各行に 10 が加算される）                   |
| C-u M-\vert q 'select c1 + 10 from -' | リージョンを q コマンドの結果で置き換える（各行に 10 が加算される）                     |
| C-u C-u M-\vert llm '和訳して'        | リージョンに対してバックグランドで llm コマンドを実行し、結果をクリップボードに格納する |
| C-u M-\vert bash                      | リージョンの内容をコマンドとしてシェルで実行し、リージョンを結果で置き換える            |
|---------------------------------------+-----------------------------------------------------------------------------------------|

※ リージョンに対する処理（C-u を前置する場合）についても、実行結果はクリップボードに格納されます。
また、全ての処理において、実行結果の最初の10行が Keyhac コンソールに表示されます。

※ 最後の使用例では、複数行のシェルスクリプトを書いて、シェルで実行させることもできます。

※ よく使うコマンドがあれば、クリップボードリストに item を一つ追加し、コマンドの雛形を登録しておくと
便利かと思います。

※ WSL に q コマンドをインストールすることにより、フィルタコマンドで SQL が利用できるようになります。

- https://harelba.github.io/q/

※ WSL に llm コマンドをインストールすることにより、フィルタコマンドで AI が利用できるようになります。

- https://github.com/simonw/llm

*** 留意事項

● Unix ツールが動作する日本語環境について

Unix ツールの日本語環境は、BusyBox が cp932、それ以外のツールが utf-8 で動作します。
ただし、BusyBox は日本語対応されている訳ではないようですので、コマンドとして入力した日本語
文字の中に￥の文字が含まれている場合、正しく動作しません。
このため、コマンドに日本語を利用したい場合には、BusyBox 以外のツールを利用することをお勧めします。

● FAKEYMACS 環境変数について

bash に -l オプションを付けて実行する場合、bash を起動する環境の .bash_profile に多くの
設定を記入していると、コマンドの実行が遅かったり、コマンドが正しくフィルタとして機能
しなかったりする場合があります。
このようなときに .bash_profile 内の設定をコントロール（除外）できるようにするため、
FAKEYMACS 環境変数を設定しています。除外したい設定は、次のとおりに if 文で囲ってください。

#+BEGIN_EXAMPLE
if [ -z "$FAKEYMACS" ]; then
    ...
fi
#+END_EXAMPLE

● エラーメッセージの表示について

発生するタイミングは分からないのですが、Keyhac コンソールに以下のメッセージが表示されることがあります。
この対策については、引き続き検討していきます。

#+BEGIN_EXAMPLE
-----------------------------------------
キーフック強制解除を検出しました.
自動的にフックの再設定を行います.

キーフックの強制解除が頻発する場合、時間のかかる処理(300ミリ秒以上)が
メインスレッドで呼び出されていないかを、確認してください.
時間のかかる処理は JobQueue/JobItem を使ってサブスレッドに追い出してください.
-----------------------------------------
#+END_EXAMPLE

● バルーンヘルプが表示されている間の操作について

バルーンヘルプが表示されている間は、PC の操作を行わないでください。
Fakeymacs のキーが効かなかったり、処理の結果が別の箇所にペーストされるなど、不都合が発生します。

● Keyhac コンソールでのタブの表示について

Keyhac コンソールでは、タブを正しく表示できません。このため、Keyhac コンソールに出力する文字列は
expandtabs 関数を使って変換を行っていますが、日本語を含む文字列では正しく変換が行われないようです。
この問題については、対策することも可能ですが、プログラムが複雑となること、Keyhac コンソールへの出力は
参考的な扱いであることから、制約事項として扱うこととします。
